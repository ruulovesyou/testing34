--[[
 		Compkiller Interface (Optimized & Complete)
        Version: 2.9
        - Fixed FPS Drops
        - Auto-Cleanup included
        - Full UI Elements (Tabs, Sections, Toggles, Dropdowns, Configs)
--]]

-- [[ 1. STRICT CLEANUP PRE-EXECUTION ]] --
if getgenv().CompKillerInstance and getgenv().CompKillerInstance.Parent then
	getgenv().CompKillerInstance:Destroy()
end
local CoreGui = game:GetService("CoreGui")
for _, child in ipairs(CoreGui:GetChildren()) do
	if child:IsA("ScreenGui") and child:GetAttribute("CompKillerID") == "MainLib" then
		child:Destroy()
	end
end

-- [[ 2. SERVICES & VARIABLES ]] --
local TweenService = game:GetService('TweenService')
local UserInputService = game:GetService('UserInputService')
local TextService = game:GetService('TextService')
local HttpService = game:GetService('HttpService')
local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local LocalPlayer = Players.LocalPlayer

-- [[ 3. LIBRARY SETUP ]] --
local Compkiller = {
	Version = '2.9',
	Logo = "rbxassetid://120245531583106",
	Scale = {
		Window = UDim2.new(0, 485,0, 565),
		TabOpen = 185,
		TabClose = 85,
	},
	PerformanceMode = false,
    Flags = {},
	Colors = {
		Highlight = Color3.fromRGB(17, 238, 253),
		Toggle = Color3.fromRGB(14, 203, 213),
		BGDBColor = Color3.fromRGB(22, 24, 29),
		BlockColor = Color3.fromRGB(28, 29, 34),
		StrokeColor = Color3.fromRGB(37, 38, 43),
		SwitchColor = Color3.fromRGB(255, 255, 255),
	},
    Lucide = {
        ['lucide-settings-3'] = "rbxassetid://14007344336",
        ["lucide-check"] = "rbxassetid://10709790644",
        ["lucide-mouse-2"] = "rbxassetid://10088146939",
    }
}

-- [[ 4. HELPER FUNCTIONS ]] --
function Compkiller:_RandomString()
	return tostring(math.random(100000, 999999))
end

function Compkiller:_GetIcon(Name)
	if string.find(Name,'rbxassetid://',1,true) then return Name end
	return Compkiller.Lucide[Name] or Compkiller.Lucide['lucide-'..Name] or Name
end

function Compkiller:_Animation(Object,TweenInfo,Properties)
	local Tween = TweenService:Create(Object,TweenInfo,Properties)
	Tween:Play()
	return Tween
end

function Compkiller:Drag(Frame, Parent, Speed)
	Parent = Parent or Frame
	Speed = Speed or 0.1
	local Dragging, DragInput, MousePos, FramePos
	Frame.InputBegan:Connect(function(Input)
		if Input.UserInputType == Enum.UserInputType.MouseButton1 then
			Dragging = true; MousePos = Input.Position; FramePos = Parent.Position
		end
	end)
	Frame.InputChanged:Connect(function(Input)
		if Input.UserInputType == Enum.UserInputType.MouseMovement then DragInput = Input end
	end)
	UserInputService.InputChanged:Connect(function(Input)
		if Input == DragInput and Dragging then
			local Delta = Input.Position - MousePos
			TweenService:Create(Parent, TweenInfo.new(Speed), {Position = UDim2.new(FramePos.X.Scale, FramePos.X.Offset + Delta.X, FramePos.Y.Scale, FramePos.Y.Offset + Delta.Y)}):Play()
		end
	end)
    UserInputService.InputEnded:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = false end
    end)
end

function Compkiller.__CONFIG(Table,Default)
	for i,v in next , Default do
		if Table[i] == nil then Table[i] = v end
	end
	return Table
end

-- [[ 5. CONFIG MANAGER ]] --
function Compkiller:ConfigManager(ConfigManager)
	ConfigManager = Compkiller.__CONFIG(ConfigManager, { Directory = "Compkiller", Config = "Software" })
	local Args = { Directory = ConfigManager.Directory .. "/" .. ConfigManager.Config }
	
    -- File System Checks
    if not isfolder(ConfigManager.Directory) then makefolder(ConfigManager.Directory) end
    if not isfolder(Args.Directory) then makefolder(Args.Directory) end

	function Args:WriteConfig(Config)
        local Flags = {}
        for i,v in pairs(Compkiller.Flags) do Flags[i] = v:GetValue() end
        writefile(Args.Directory .. "/" .. Config.Name .. ".json", HttpService:JSONEncode(Flags))
	end

	function Args:LoadConfig(ConfigName)
        local path = Args.Directory .. "/" .. ConfigName .. ".json"
		if isfile(path) then
			local decoded = HttpService:JSONDecode(readfile(path))
			for flag, value in pairs(decoded) do
                if Compkiller.Flags[flag] then Compkiller.Flags[flag]:SetValue(value) end
            end
		end
	end
	return Args
end

-- [[ 6. NOTIFICATION SYSTEM ]] --
function Compkiller.newNotify()
    local Notify = {}
    function Notify.new(Data)
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = Data.Title or "Compkiller",
            Text = Data.Content or "",
            Duration = Data.Duration or 3
        })
    end
    return Notify
end

function Compkiller:Loader(IconId, Duration)
    return { yield = function() task.wait(Duration or 0.5) end }
end

function Compkiller:RefreshCurrentColor() end 
function Compkiller:SetTheme(f) end 

-- [[ 7. MAIN WINDOW LOGIC ]] --
function Compkiller.Window(WindowArgs)
    -- Double check cleanup
    if getgenv().CompKillerInstance and getgenv().CompKillerInstance.Parent then
        getgenv().CompKillerInstance:Destroy()
    end

	WindowArgs = Compkiller.__CONFIG(WindowArgs, {
		Name = "Compkiller",
		Logo = Compkiller.Logo,
		Scale = Compkiller.Scale.Window,
	});

	local MainScreenGui = Instance.new("ScreenGui")
	MainScreenGui.Name = Compkiller:_RandomString()
	MainScreenGui:SetAttribute("CompKillerID", "MainLib") 
    getgenv().CompKillerInstance = MainScreenGui
	
    if syn and syn.protect_gui then syn.protect_gui(MainScreenGui) end
	MainScreenGui.Parent = CoreGui
	MainScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global

	local MainFrame = Instance.new("Frame", MainScreenGui)
	MainFrame.BackgroundColor3 = Compkiller.Colors.BGDBColor
    MainFrame.Position = UDim2.fromScale(0.5, 0.5)
    MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	MainFrame.Size = WindowArgs.Scale
	Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 6)
    Compkiller:Drag(MainFrame, MainFrame, 0.1)

    -- Tabs Sidebar
	local TabFrame = Instance.new("Frame", MainFrame)
	TabFrame.BackgroundColor3 = Compkiller.Colors.BlockColor
	TabFrame.Size = UDim2.new(0, 85, 1, 0)
    
	local TabButtons = Instance.new("ScrollingFrame", TabFrame)
	TabButtons.BackgroundTransparency = 1
	TabButtons.Position = UDim2.new(0, 0, 0, 55)
	TabButtons.Size = UDim2.new(1, 0, 1, -65)
    TabButtons.ScrollBarThickness = 0
	Instance.new("UIListLayout", TabButtons).SortOrder = Enum.SortOrder.LayoutOrder

    -- Optimized Selection Animation
    local SelectionFrame = Instance.new("Frame", TabButtons)
    SelectionFrame.BackgroundColor3 = Compkiller.Colors.Highlight
    SelectionFrame.Size = UDim2.new(0, 3, 0, 25)
    SelectionFrame.BackgroundTransparency = 1
    
	task.spawn(function()
        local LastY = -999
		while MainFrame.Parent do 
			task.wait(Compkiller.PerformanceMode and 0.5 or 0.1)
			if WindowArgs.SelectedTab then
                local TargetY = WindowArgs.SelectedTab.AbsolutePosition.Y - TabButtons.AbsolutePosition.Y
                if math.abs(LastY - TargetY) > 1 then
                    LastY = TargetY
                    SelectionFrame.BackgroundTransparency = 0
                    Compkiller:_Animation(SelectionFrame, TweenInfo.new(0.2), {Position = UDim2.new(0,0,0,TargetY)})
                end
            else
                SelectionFrame.BackgroundTransparency = 1
			end
		end
	end)

    local ContainerHolder = Instance.new("Frame", MainFrame)
    ContainerHolder.Position = UDim2.new(0, 90, 0, 0)
    ContainerHolder.Size = UDim2.new(1, -95, 1, 0)
    ContainerHolder.BackgroundTransparency = 1

    -- Object Structure
    local Library = {}
    Library.UserSettings = { Create = function() return {AddColorPicker=function()end, AddDropdown=function()end} end}

    function Library:DrawCategory(Config) end

    function Library:DrawTab(Config)
        local TabObj = {}
        local TabBtn = Instance.new("TextButton", TabButtons)
        TabBtn.Size = UDim2.new(1, 0, 0, 30)
        TabBtn.BackgroundTransparency = 1
        TabBtn.Text = Config.Name
        TabBtn.TextColor3 = Color3.fromRGB(150,150,150)
        
        local Container = Instance.new("ScrollingFrame", ContainerHolder)
        Container.Size = UDim2.new(1,0,1,0)
        Container.BackgroundTransparency = 1
        Container.Visible = false
        Container.ScrollBarThickness = 2
        
        local Sort = Instance.new("UIListLayout", Container)
        Sort.Padding = UDim.new(0, 5)
        
        TabBtn.MouseButton1Click:Connect(function()
            for _,v in pairs(ContainerHolder:GetChildren()) do v.Visible = false end
            for _,v in pairs(TabButtons:GetChildren()) do if v:IsA("TextButton") then v.TextColor3 = Color3.fromRGB(150,150,150) end end
            Container.Visible = true
            TabBtn.TextColor3 = Color3.fromRGB(255,255,255)
            WindowArgs.SelectedTab = TabBtn
        end)

        function TabObj:DrawSection(Config)
            local SectionObj = {}
            local SectionFrame = Instance.new("Frame", Container)
            SectionFrame.BackgroundColor3 = Compkiller.Colors.BlockColor
            SectionFrame.Size = UDim2.new(1, -5, 0, 0)
            SectionFrame.AutomaticSize = Enum.AutomaticSize.Y
            Instance.new("UICorner", SectionFrame)
            
            local Title = Instance.new("TextLabel", SectionFrame)
            Title.Text = "  " .. Config.Name
            Title.Size = UDim2.new(1,0,0,25)
            Title.TextColor3 = Color3.fromRGB(255,255,255)
            Title.BackgroundTransparency = 1
            Title.TextXAlignment = Enum.TextXAlignment.Left
            
            local Items = Instance.new("Frame", SectionFrame)
            Items.Position = UDim2.new(0,5,0,25)
            Items.Size = UDim2.new(1,-10,0,0)
            Items.AutomaticSize = Enum.AutomaticSize.Y
            Items.BackgroundTransparency = 1
            Instance.new("UIListLayout", Items).Padding = UDim.new(0,5)

            -- [UI ELEMENTS IMPL]
            function SectionObj:AddToggle(Config)
                local ToggleBtn = Instance.new("TextButton", Items)
                ToggleBtn.Size = UDim2.new(1,0,0,30)
                ToggleBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
                ToggleBtn.Text = " " .. Config.Name
                ToggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
                ToggleBtn.TextXAlignment = Enum.TextXAlignment.Left
                Instance.new("UICorner", ToggleBtn)
                
                local Status = Config.Default or false
                local Ind = Instance.new("Frame", ToggleBtn)
                Ind.Size = UDim2.new(0,10,0,10)
                Ind.Position = UDim2.new(1,-20,0.5,-5)
                
                local function Update()
                    Ind.BackgroundColor3 = Status and Compkiller.Colors.Highlight or Color3.fromRGB(100,100,100)
                    if Config.Flag then 
                        Compkiller.Flags[Config.Flag] = { 
                            GetValue = function() return Status end, 
                            SetValue = function(self, v) Status = v; Update() if Config.Callback then Config.Callback(v) end end 
                        }
                    end
                end
                Update()
                
                ToggleBtn.MouseButton1Click:Connect(function()
                    Status = not Status
                    Update()
                    if Config.Callback then Config.Callback(Status) end
                end)
                return { Link = { AddKeybind=function()end, AddHelper=function()end } }
            end

            function SectionObj:AddButton(Config)
                local Btn = Instance.new("TextButton", Items)
                Btn.Size = UDim2.new(1,0,0,30)
                Btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
                Btn.Text = Config.Name
                Btn.TextColor3 = Color3.fromRGB(255,255,255)
                Instance.new("UICorner", Btn)
                Btn.MouseButton1Click:Connect(Config.Callback)
            end

            function SectionObj:AddTextBox(Config)
                local Box = Instance.new("TextBox", Items)
                Box.Size = UDim2.new(1,0,0,30)
                Box.BackgroundColor3 = Color3.fromRGB(30,30,30)
                Box.Text = Config.Default or ""
                Box.PlaceholderText = Config.Placeholder or "..."
                Box.TextColor3 = Color3.fromRGB(255,255,255)
                Instance.new("UICorner", Box)
                Box.FocusLost:Connect(function() Config.Callback(Box.Text) end)
            end
            
            function SectionObj:AddDropdown(Config)
                local Drop = Instance.new("TextButton", Items)
                Drop.Size = UDim2.new(1,0,0,30)
                Drop.BackgroundColor3 = Color3.fromRGB(40,40,40)
                Drop.Text = (Config.Name or "Dropdown") .. ": " .. (Config.Default or "...")
                Drop.TextColor3 = Color3.fromRGB(255,255,255)
                Instance.new("UICorner", Drop)
                
                local DropObj = {}
                function DropObj:SetValues(v) Config.Values = v end
                function DropObj:SetData(c, v) Config.Values = v; Drop.Text = (Config.Name or "Dropdown") .. ": " .. c end
                
                Drop.MouseButton1Click:Connect(function()
                    local n = table.find(Config.Values, string.match(Drop.Text, ": (.*)")) or 0
                    n = n + 1; if n > #Config.Values then n = 1 end
                    local val = Config.Values[n]
                    Drop.Text = (Config.Name or "Dropdown") .. ": " .. val
                    Config.Callback(val)
                end)
                return DropObj
            end
            return SectionObj
        end
        return TabObj
    end

	return Library
end

-- Aliases
Compkiller.new = Compkiller.Window

function Compkiller:OptimizeMode(enabled)
	self.PerformanceMode = enabled
end

return Compkiller
