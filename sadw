--[[
    Compkiller Interface (Stable & Fixed)
    Version: 3.0
    - FIXED: Game Crashes (Removed infinite loops)
    - FIXED: Config Saving (Restored native file system)
    - FIXED: Dropdown/Toggle Functions
    - ADDED: Auto-Cleanup
--]]

-- [1] SERVICES
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- [2] STRICT CLEANUP (Prevents Duplicates)
if getgenv().CompKillerInstance and getgenv().CompKillerInstance.Parent then
    getgenv().CompKillerInstance:Destroy()
end
for _, child in ipairs(CoreGui:GetChildren()) do
    if child:IsA("ScreenGui") and child:GetAttribute("CompKillerID") == "MainLib" then
        child:Destroy()
    end
end

-- [3] LIBRARY SETUP
local Compkiller = {
    Version = '3.0',
    Logo = "rbxassetid://120245531583106",
    Scale = { Window = UDim2.new(0, 485,0, 565) },
    Flags = {},
    Colors = {
        Highlight = Color3.fromRGB(17, 238, 253),
        BGDBColor = Color3.fromRGB(22, 24, 29),
        BlockColor = Color3.fromRGB(28, 29, 34),
        TextColor = Color3.fromRGB(255, 255, 255),
    },
    Lucide = {
        ['lucide-settings-3'] = "rbxassetid://14007344336",
        ["lucide-check"] = "rbxassetid://10709790644",
        ["lucide-mouse-2"] = "rbxassetid://10088146939",
    }
}

-- [4] HELPER FUNCTIONS
function Compkiller:_RandomString()
    return tostring(math.random(100000, 999999))
end

function Compkiller:_GetIcon(Name)
    if string.find(Name, 'rbxassetid://', 1, true) then return Name end
    return Compkiller.Lucide[Name] or Compkiller.Lucide['lucide-'..Name] or Name
end

function Compkiller:Drag(Frame, Parent)
    Parent = Parent or Frame
    local Dragging, DragInput, MousePos, FramePos
    Frame.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true; MousePos = Input.Position; FramePos = Parent.Position
        end
    end)
    Frame.InputChanged:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseMovement then DragInput = Input end
    end)
    UserInputService.InputChanged:Connect(function(Input)
        if Input == DragInput and Dragging then
            local Delta = Input.Position - MousePos
            TweenService:Create(Parent, TweenInfo.new(0.1), {
                Position = UDim2.new(FramePos.X.Scale, FramePos.X.Offset + Delta.X, FramePos.Y.Scale, FramePos.Y.Offset + Delta.Y)
            }):Play()
        end
    end)
    UserInputService.InputEnded:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = false end
    end)
end

function Compkiller.__CONFIG(Table, Default)
    for i, v in next, Default do
        if Table[i] == nil then Table[i] = v end
    end
    return Table
end

-- [5] CONFIG MANAGER (Fixed)
function Compkiller:ConfigManager(ConfigManager)
    ConfigManager = Compkiller.__CONFIG(ConfigManager, { Directory = "Compkiller", Config = "Software" })
    local Args = { Directory = ConfigManager.Directory .. "/" .. ConfigManager.Config }

    -- Safe Folder Creation
    if makefolder then
        if not isfolder(ConfigManager.Directory) then makefolder(ConfigManager.Directory) end
        if not isfolder(Args.Directory) then makefolder(Args.Directory) end
    end

    function Args:WriteConfig(Config)
        local Flags = {}
        for i, v in pairs(Compkiller.Flags) do Flags[i] = v:GetValue() end
        if writefile then
            writefile(Args.Directory .. "/" .. Config.Name .. ".json", HttpService:JSONEncode(Flags))
        end
    end

    function Args:LoadConfig(ConfigName)
        local path = Args.Directory .. "/" .. ConfigName .. ".json"
        if isfile and isfile(path) then
            local success, decoded = pcall(function() return HttpService:JSONDecode(readfile(path)) end)
            if success and decoded then
                for flag, value in pairs(decoded) do
                    if Compkiller.Flags[flag] then Compkiller.Flags[flag]:SetValue(value) end
                end
            end
        end
    end
    return Args
end

-- [6] NOTIFICATION SYSTEM
function Compkiller.newNotify()
    local Notify = {}
    function Notify.new(Data)
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = Data.Title or "Compkiller",
            Text = Data.Content or "",
            Duration = Data.Duration or 3
        })
    end
    return Notify
end

function Compkiller:Loader(IconId, Duration)
    return { yield = function() task.wait(Duration or 0.5) end }
end

function Compkiller:RefreshCurrentColor() end 
function Compkiller:SetTheme(f) end 
function Compkiller:OptimizeMode(enabled) end

-- [7] MAIN UI LOGIC
function Compkiller.Window(WindowArgs)
    WindowArgs = Compkiller.__CONFIG(WindowArgs, {
        Name = "Compkiller",
        Logo = Compkiller.Logo,
        Scale = Compkiller.Scale.Window,
    })

    -- Create GUI
    local MainScreenGui = Instance.new("ScreenGui")
    MainScreenGui.Name = Compkiller:_RandomString()
    MainScreenGui:SetAttribute("CompKillerID", "MainLib") 
    getgenv().CompKillerInstance = MainScreenGui
    
    if syn and syn.protect_gui then syn.protect_gui(MainScreenGui) end
    MainScreenGui.Parent = CoreGui
    MainScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global

    local MainFrame = Instance.new("Frame", MainScreenGui)
    MainFrame.BackgroundColor3 = Compkiller.Colors.BGDBColor
    MainFrame.Position = UDim2.fromScale(0.5, 0.5)
    MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    MainFrame.Size = WindowArgs.Scale
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 6)
    
    Compkiller:Drag(MainFrame, MainFrame)

    -- Tabs Container
    local TabFrame = Instance.new("Frame", MainFrame)
    TabFrame.BackgroundColor3 = Compkiller.Colors.BlockColor
    TabFrame.Size = UDim2.new(0, 85, 1, 0)
    
    local TabButtons = Instance.new("ScrollingFrame", TabFrame)
    TabButtons.BackgroundTransparency = 1
    TabButtons.Position = UDim2.new(0, 0, 0, 55)
    TabButtons.Size = UDim2.new(1, 0, 1, -65)
    TabButtons.ScrollBarThickness = 0
    Instance.new("UIListLayout", TabButtons).SortOrder = Enum.SortOrder.LayoutOrder

    local SelectionFrame = Instance.new("Frame", TabButtons)
    SelectionFrame.BackgroundColor3 = Compkiller.Colors.Highlight
    SelectionFrame.Size = UDim2.new(0, 3, 0, 30)
    SelectionFrame.BackgroundTransparency = 1

    local ContainerHolder = Instance.new("Frame", MainFrame)
    ContainerHolder.Position = UDim2.new(0, 90, 0, 0)
    ContainerHolder.Size = UDim2.new(1, -95, 1, 0)
    ContainerHolder.BackgroundTransparency = 1

    -- Setup Logic
    local Library = {}
    Library.UserSettings = { Create = function() return {AddColorPicker=function()end, AddDropdown=function()end} end }

    function Library:DrawCategory(Config) end

    function Library:DrawTab(Config)
        local TabBtn = Instance.new("TextButton", TabButtons)
        TabBtn.Size = UDim2.new(1, 0, 0, 30)
        TabBtn.BackgroundTransparency = 1
        TabBtn.Text = Config.Name
        TabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
        TabBtn.Font = Enum.Font.Gotham
        TabBtn.TextSize = 13

        local Container = Instance.new("ScrollingFrame", ContainerHolder)
        Container.Size = UDim2.new(1, 0, 1, 0)
        Container.BackgroundTransparency = 1
        Container.Visible = false
        Container.ScrollBarThickness = 2
        
        local Sort = Instance.new("UIListLayout", Container)
        Sort.Padding = UDim.new(0, 5)

        -- Tab Selection Logic (Event Based - NO LOOP)
        TabBtn.MouseButton1Click:Connect(function()
            -- Hide old
            for _, v in pairs(ContainerHolder:GetChildren()) do v.Visible = false end
            for _, v in pairs(TabButtons:GetChildren()) do 
                if v:IsA("TextButton") then v.TextColor3 = Color3.fromRGB(150, 150, 150) end 
            end
            
            -- Show new
            Container.Visible = true
            TabBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
            
            -- Move Selection Bar
            SelectionFrame.BackgroundTransparency = 0
            TweenService:Create(SelectionFrame, TweenInfo.new(0.2), {
                Position = UDim2.new(0, 0, 0, TabBtn.AbsolutePosition.Y - TabButtons.AbsolutePosition.Y)
            }):Play()
        end)

        local TabObj = {}
        function TabObj:DrawSection(Config)
            local SectionFrame = Instance.new("Frame", Container)
            SectionFrame.BackgroundColor3 = Compkiller.Colors.BlockColor
            SectionFrame.Size = UDim2.new(1, -5, 0, 0)
            SectionFrame.AutomaticSize = Enum.AutomaticSize.Y
            Instance.new("UICorner", SectionFrame)

            local Title = Instance.new("TextLabel", SectionFrame)
            Title.Text = "  " .. Config.Name
            Title.Size = UDim2.new(1, 0, 0, 25)
            Title.TextColor3 = Compkiller.Colors.TextColor
            Title.BackgroundTransparency = 1
            Title.TextXAlignment = Enum.TextXAlignment.Left
            Title.Font = Enum.Font.GothamBold
            Title.TextSize = 12

            local Items = Instance.new("Frame", SectionFrame)
            Items.Position = UDim2.new(0, 5, 0, 25)
            Items.Size = UDim2.new(1, -10, 0, 0)
            Items.AutomaticSize = Enum.AutomaticSize.Y
            Items.BackgroundTransparency = 1
            Instance.new("UIListLayout", Items).Padding = UDim.new(0, 5)

            local SectionObj = {}

            -- [TOGGLE]
            function SectionObj:AddToggle(Config)
                local ToggleBtn = Instance.new("TextButton", Items)
                ToggleBtn.Size = UDim2.new(1, 0, 0, 30)
                ToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                ToggleBtn.Text = " " .. Config.Name
                ToggleBtn.TextColor3 = Compkiller.Colors.TextColor
                ToggleBtn.TextXAlignment = Enum.TextXAlignment.Left
                ToggleBtn.Font = Enum.Font.Gotham
                ToggleBtn.TextSize = 13
                Instance.new("UICorner", ToggleBtn)

                local Status = Config.Default or false
                local Ind = Instance.new("Frame", ToggleBtn)
                Ind.Size = UDim2.new(0, 10, 0, 10)
                Ind.Position = UDim2.new(1, -20, 0.5, -5)
                Instance.new("UICorner", Ind, UDim.new(1,0))

                local function Update()
                    Ind.BackgroundColor3 = Status and Compkiller.Colors.Highlight or Color3.fromRGB(100, 100, 100)
                    if Config.Flag then
                        Compkiller.Flags[Config.Flag] = {
                            GetValue = function() return Status end,
                            SetValue = function(self, v) Status = v; Update(); if Config.Callback then Config.Callback(v) end end
                        }
                    end
                end
                Update()

                ToggleBtn.MouseButton1Click:Connect(function()
                    Status = not Status
                    Update()
                    if Config.Callback then Config.Callback(Status) end
                end)
                return { Link = { AddKeybind=function()end, AddHelper=function()end } }
            end

            -- [BUTTON]
            function SectionObj:AddButton(Config)
                local Btn = Instance.new("TextButton", Items)
                Btn.Size = UDim2.new(1, 0, 0, 30)
                Btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                Btn.Text = Config.Name
                Btn.TextColor3 = Compkiller.Colors.TextColor
                Btn.Font = Enum.Font.Gotham
                Instance.new("UICorner", Btn)
                Btn.MouseButton1Click:Connect(Config.Callback)
            end

            -- [TEXTBOX]
            function SectionObj:AddTextBox(Config)
                local Box = Instance.new("TextBox", Items)
                Box.Size = UDim2.new(1, 0, 0, 30)
                Box.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                Box.Text = Config.Default or ""
                Box.PlaceholderText = Config.Placeholder or "..."
                Box.TextColor3 = Compkiller.Colors.TextColor
                Box.Font = Enum.Font.Gotham
                Instance.new("UICorner", Box)
                Box.FocusLost:Connect(function() Config.Callback(Box.Text) end)
            end

            -- [DROPDOWN]
            function SectionObj:AddDropdown(Config)
                local DropBtn = Instance.new("TextButton", Items)
                DropBtn.Size = UDim2.new(1, 0, 0, 30)
                DropBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                DropBtn.Text = (Config.Name) .. ": " .. (Config.Default or "Select")
                DropBtn.TextColor3 = Compkiller.Colors.TextColor
                DropBtn.Font = Enum.Font.Gotham
                Instance.new("UICorner", DropBtn)

                local DropObj = {}
                
                -- Support SetValues and SetData for your Config Manager
                function DropObj:SetValues(NewValues)
                    Config.Values = NewValues
                end
                
                function DropObj:SetData(Current, NewValues)
                    Config.Values = NewValues
                    DropBtn.Text = (Config.Name) .. ": " .. tostring(Current)
                end

                DropBtn.MouseButton1Click:Connect(function()
                    -- Simple Cycler for stability
                    local CurrentText = string.match(DropBtn.Text, ": (.*)")
                    local Index = table.find(Config.Values, CurrentText) or 0
                    Index = Index + 1
                    if Index > #Config.Values then Index = 1 end
                    
                    local NewVal = Config.Values[Index]
                    DropBtn.Text = (Config.Name) .. ": " .. tostring(NewVal)
                    if Config.Callback then Config.Callback(NewVal) end
                end)
                
                return DropObj
            end

            return SectionObj
        end
        return TabObj
    end

    return Library
end

-- Aliases
Compkiller.new = Compkiller.Window

return Compkiller
